---
# Playbook used to download (archived) Mnesia backup from last host in the playbook hosts
#
# By default the archive destination is overwritten if already exists,
# if archive overwrite is not intended the caller is responsible for setting correct (e.g. unique) "backup_suffix"
#
# Example steps to restore a mnesia backup:
# 1. Stop the node
# 2. Delete existing mnesia database if any
# 3. Disable mining autostart and empty the peers list in the config
# 4. Start the node
# 5. Restore the backup with "mnesia:restore("/tmp/mnesia.bak", [])."
# 6. Enable mining autostart and restore the peers list in the config
# 7. Start the node

- name: Backup, archive and download Mnesia database
  hosts: "{{ ansible_play_hosts | last }}"
  remote_user: aeternity

  tasks:
    - name: Include configuration variables
      include_vars: backup/config.yml

    - name: Download backup to S3 bucket latest
      aws_s3:
        bucket: "{{ backup_bucket }}"
        object: "{{ backup_archive_filename_latest }}"
        dest: /tmp/{{ backup_archive_filename_latest }}
        mode: get

    - name: Unaarchive backup
      unarchive:
        remote_src: yes
        src: /tmp/{{ backup_archive_filename_latest }}
        dest: /tmp/

    - import_tasks: backup/disable_mining_and_peers.yml

    - meta: flush_handlers

    - name: Wait aeternity node API to boot
      wait_for:
        port: "{{ node_config.http.external.port }}"
        host: "{{ public_ipv4 }}"
        timeout: 300
      when: health_check

      tags: [health-check]

    - name: Restore Mnesia database
      command: "{{ aeternity_bin }} eval '{atomic, _} = mnesia:restore(\"/tmp/backup\", [{default_op, recreate_tables}]).'"
      register: restore_result
      changed_when: "restore_result.stdout|search('atomic')"

    - debug:
        var: restore_result
    - import_tasks: backup/restore_mining_and_peers_config.yml

    - name: Remove Mnesia backups
      file:
        path:  "{{ item }}"
        state: absent
      loop:
        - /tmp/backup
        - /tmp/{{ backup_archive_filename_latest }}

  handlers:
  - import_tasks: handlers.yml
