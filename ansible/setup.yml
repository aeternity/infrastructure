---
- name: Configure node servers
  hosts: all
  remote_user: master
  become: yes

  vars:
    project_user: aeternity
    vault_version: "0.11.3"
    libsodium_version: "1.0.16"
    libsodium_module_version: "23.1.0"
    fail2ban_enable: true
    fail2ban_loglevel: INFO
    fail2ban_bantime: 86400
    fail2ban_maxretry: 3
    fail2ban_logtarget: SYSLOG
    fail2ban_action: action_
    fail2ban_services:
      - name: ssh
        port: ssh
        filter: sshd
        logpath: /var/log/auth.log
    restart_ssh: yes

  tasks:
    - name: Create aeternity daemon user
      user:
        name: "{{ project_user }}"
        shell: /bin/bash
      tags:
        - project-user

    - name: Create master user
      user:
        name: master
        shell: /bin/bash
      tags:
        - master-user

    - name: Disallow root SSH access
      lineinfile: dest=/etc/ssh/sshd_config
                  regexp="^PermitRootLogin"
                  line="PermitRootLogin no"
                  state=present
      tags:
        - root-user
      notify: restart ssh

    - name: Download Vault public key
      get_url:
        url: "{{ vault_addr }}/v1/ssh/public_key"
        dest: /etc/ssh/trusted-user-ca-keys.pem
      when: vault_addr is defined
      tags:
        - ssh-keys
        - developer-ssh-keys
      notify: restart ssh

    - name: Setup trusted CA in sshd config
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^TrustedUserCAKeys'
        line: 'TrustedUserCAKeys /etc/ssh/trusted-user-ca-keys.pem'
      when: vault_addr is defined
      tags:
        - ssh-keys
        - developer-ssh-keys
      notify: restart ssh

    - name: Install GPG
      apt:
        state: present
        update_cache: yes
        pkg:
        - gnupg
      tags:
        - dev-tools

    - name: Add Docker GPG apt Key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker Repository
      apt_repository:
        repo: "deb https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install dev and ops tools
      apt:
        state: present
        update_cache: yes
        pkg:
        - sudo
        - docker-ce
        - build-essential
        - python3-pip
        - python3-distutils
        - python3-apt
        - python3-yaml #aeternity.fact
        - python3-docker
        - libssl-dev
        - libffi-dev
        - jq
        - unzip
        - bc
        - curl
        - zstd
      tags:
        - dev-tools

    - name: Prepare pip
      pip:
        name:
          - pip==21.3.1
          - setuptools-rust==1.1.2
      tags:
        - dev-tools

    - name: Install pip dependencies
      pip:
        name:
          # This should match the same versions as in requirements.txt
          - ansible==4.10.0
          - awscli==1.22.30
          - boto3==1.20.30
          - boto==2.49.0
          - datadog==0.28.0
          - hvac==0.6.4
          - pyyaml==3.12.0
          - wheel==0.37.1
      # "pip3 install ansible" fails otherwise
      # see https://github.com/pypa/pip/issues/10219#issuecomment-887337037
      environment:
        LANG: C.UTF-8
        LC_ALL: C.UTF-8
      tags:
        - dev-tools

    - name: Add user '{{ user }}' to docker group
      user:
        name: '{{ item }}'
        groups: sudo
        append: yes
      loop: ['ubuntu', 'master', 'aeternity']

    - name: Create Vault source directory
      file:
        path: /usr/src/vault-{{ vault_version }}/
        state: directory
      tags:
        - vault-install

    - name: Download and unarchive Vault binary
      unarchive:
        src: "https://releases.hashicorp.com/vault/{{ vault_version }}/vault_{{ vault_version }}_linux_amd64.zip"
        dest: /usr/src/vault-{{ vault_version }}/
        creates: /usr/src/vault-{{ vault_version }}/vault
        remote_src: true
      tags:
        - vault-install

    - name: Install Vault binary
      copy:
        src: /usr/src/vault-{{ vault_version }}/vault
        dest: /usr/bin/vault
        mode: 0755
        remote_src: true
      tags:
        - vault-install

    - name: "Create custom fact directory"
      file:
        path: "/etc/ansible/facts.d"
        state: "directory"
      tags:
        - ansible-facts

    - name: "Install aeternity.fact file"
      copy:
        src: files/aeternity.fact
        dest: /etc/ansible/facts.d/aeternity.fact
        mode: 0755
      tags:
        - ansible-facts

    - name: Increase ulimit
      pam_limits:
        domain: "{{ project_user }}"
        limit_type: soft
        limit_item: nofile
        value: 24576

    - name: Include task to install Ubuntu {{ ansible_distribution_version }} dependencies
      include_tasks: tasks/{{ ansible_distribution | lower }}_{{ ansible_distribution_release | lower }}.yml
      tags: vars

    - name: Attach additional drive if needed
      include_tasks: tasks/additional_storage.yml

  handlers:
    - name: Run ldconfig
      command: ldconfig
      listen: run ldconfig

    - name: Restart ssh
      service:
        name: ssh
        state: restarted
        use: service_mgr|default(ansible_service_mgr)
      listen: restart ssh
      when: restart_ssh|bool

  roles:
    - role: jasonheecs.ubuntu-fail2ban
      when: fail2ban_enable|bool
