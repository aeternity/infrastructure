---
# Playbook used to download mnesia snapshot for env from S3 and restore it to give node

- name: Backup, archive and download Mnesia database
  hosts: all
  remote_user: aeternity

  tasks:
    - name: Include configuration variables
      include_vars: vars/snapshot.yml

    - name: "Load a variable files for environment: {{ env }}"
      include_vars: "{{ item }}"
      with_first_found:
        - "../vars/aeternity/{{ env }}.yml"
      tags: [config, node_config]

    - name: Download backup to S3 bucket latest
      aws_s3:
        bucket: "{{ snapshots_bucket }}"
        object: "{{ restore_snapshot_filename }}"
        dest: /tmp/{{ restore_snapshot_filename }}
        mode: get

    - name: Stop node
      command: "/bin/true"
      changed_when: true
      notify: "stop aeternity daemon"

    - meta: flush_handlers

    - name: Restore Mnesia database (with additional storage)
      unarchive:
        remote_src: yes
        src: /tmp/{{ restore_snapshot_filename }}
        dest: "{{ additional_storage_mountpoint }}/"
      when:
        - additional_storage is defined
        - additional_storage

    - name: Restore Mnesia database (without additional storage)
      unarchive:
        remote_src: yes
        src: /tmp/{{ restore_snapshot_filename }}
        dest: "{{ project_root }}/"
      when:
        - additional_storage is not defined or not additional_storage

    - name: Remove Mnesia backups
      file:
        path:  "{{ item }}"
        state: absent
      loop:
        - /tmp/backup
        - /tmp/{{ restore_snapshot_filename }}

    - name: Start node
      command: "/bin/true"
      changed_when: true
      notify: "start aeternity daemon"

  handlers:
  - import_tasks: tasks/handlers.yml
